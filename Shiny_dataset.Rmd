---
title: "Shiny App"
output: html_document
https://www.kaggle.com/dorbicycle/world-foodfeed-production/home
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# load libraries
```{r libraries}
library(tidyr)
library(devtools)
library(DataExplorer)
library(rvest)
library(dplyr)
library(lubridate)
library(stringr)
library(readr)
library(timeDate)
library(shiny)
library(plotly)
library(ggplot2)
library(ggthemes)
library(Hmisc)
library(microbenchmark)
library(knitr)
library(shinythemes)
library(shinyWidgets)
library(rgdal)
library(maps)
library(rworldmap)
```


#Import Data
```{r import data}
# UN food production data
data <- read_csv('C:/Users/BieniekJon/Desktop/901/R/Shiny/FAO.csv')
print(data)

# UN countries by region
region <- read_csv('C:/Users/BieniekJon/Desktop/901/R/Shiny/Region list.csv')
print(region)

# Food categories
categories <- read_csv('C:/Users/BieniekJon/Desktop/901/R/Shiny/Food Categories.csv')
print(categories)
```

# Use left join to add region and food categories to the UN data set
```{r join data}
joined_data <- left_join(data,region,by = c("Area" = "Country"))
print(joined_data)

joined_data2 <- left_join(joined_data,categories,by = c("Item" = "Items"))
print(joined_data2)
```

Remove and row with an NA
```{r remove NAs}
no_na <- joined_data2[complete.cases(joined_data2),]
no_na[is.na(no_na$`Food_Sub_Category`),]
```

Subset the data
```{r}
columns_of_interest <- c("Element","Area","Region","Food_Sub_Category", 
                         "Y1961", "Y1962", "Y1963", "Y1964", "Y1965","Y1966",
                         "Y1967","Y1968","Y1969","Y1970","Y1971","Y1972","Y1973",
                         "Y1974","Y1975","Y1976","Y1977","Y1978","Y1979","Y1980",
                         "Y1981","Y1982","Y1983","Y1984","Y1985","Y1986","Y1987",
                         "Y1988","Y1989","Y1990","Y1991","Y1992","Y1993","Y1994",
                         "Y1995","Y1996","Y1997","Y1998","Y1999","Y2000","Y2001",
                         "Y2002","Y2003","Y2004","Y2005","Y2006","Y2007","Y2008",
                         "Y2009","Y2010","Y2011","Y2012","Y2013")

data_subset <- no_na[columns_of_interest]
print(data_subset)
```

# Create a flat file using the gather() function.
```{r flat_file}
flat_all_yrs <- gather(data_subset, 
                              "Year", "Prod_one_tho_ton", 5:57)
print(flat_all_yrs)
```

Remove the letter Y from Year elements
```{r remove letter from string}
flat_all_yrs$Year <- gsub("Y", "",flat_all_yrs$Year)
print(flat_all_yrs)
```
Subset the years so the visualizations are more manageable
```{r subset years}
flat_file <- flat_all_yrs[flat_all_yrs$Year>=1993,]
print(flat_file)
```

Transform all columns except the Production column into factors. This will make ploting graphs easier.
```{r turn to factors}
flat_file$Element <- as.factor(flat_file$Element)
flat_file$Area <- as.factor(flat_file$Area)
flat_file$Region <- as.factor(flat_file$Region)
flat_file$Food_Sub_Category <- as.factor(flat_file$Food_Sub_Category)
flat_file$Year <- as.factor(flat_file$Year)
```

Shiny App
Variables for shiny
```{r shiny variables}
regions <- sort(unique(flat_file$Region))
food_cat <- sort(unique(flat_file$Food_Sub_Category))
```

Bring in GGPlot Map data and bring in Region from my dataset
```{r map data}
flat_file_subset <- flat_file[,c("Area","Region")]
data_dedup2 <- distinct(flat_file_subset)
map_world <- map_data(map="world")
map_world_tbl <- as_tibble(map_world)
map_world2 <- left_join(map_world_tbl,data_dedup2,by = c("region" = "Area"))
map_world_fin <- distinct(map_world2)


map_world_fin[map_world_fin$region=="Russia",]
```

Test map
```{r test map}
       g <-ggplot()
       g <- g + theme(legend.position="none")
       g <- g + geom_map(data=map_world_fin, map=map_world_fin, aes(map_id=region, x=long, y=lat, fill="white"))
       g

```

Shiny code
```{r}
# Define UI for application that plots features of movies
ui <- shinyUI(
    navbarPage("Global Food and Feed Production",
               tabPanel("Insights",
  
  # Sidebar layout with a input and output definitions
  sidebarLayout(
    
    # Inputs
    sidebarPanel(
        tags$h3("Inputs"),
        radioButtons(inputId = "purpose", 
                     label = "Intended use of Goods Produced", 
                     choices =c("Human Consumption" = "Food",
                                "Animal Consumption" = "Feed"),
                     selected = "Food"),
        
        pickerInput(inputId = "region",
                    label = "Global Regions:",
                    choices = regions,
                    options = list(`actions-box` = TRUE),
                    multiple = TRUE),
        
        pickerInput(inputId = "group",
                    label = "Food/Feed Category:",
                    choices = food_cat,
                    options = list(`actions-box` = TRUE),
                    multiple = TRUE)
                  ),
      
      # Outputs
      mainPanel(
        tabsetPanel(
          tabPanel("Stacked by Region",
                   h2("Total Production"),
                   plotlyOutput(outputId = "barplot"),
                   plotlyOutput(outputId = "map1")),
          tabPanel("Stacked by Food Category",
                   h2("Total Production"),
                   plotlyOutput(outputId = "barplot2")),
          tabPanel("Data Table",
                  h2("Data Table"),
                  dataTableOutput(outputId = "table")
                    )
                  )
                )
              )
            ),
  
      # Will be a Read Me
                tabPanel("README"
  
                 
                )    
              )
            )
# Define server function required to create the scatterplot
server <- function(input, output,session) {
  
### reactive filtered data from inputs 
      filtered_data <- reactive({filter(flat_file, Element == input$purpose)})
      observe({
                updateSelectInput(session,"region", 
                                  choices = unique(filtered_data()$Region))
        })
      
      filtered_data_2 <- reactive({filter(filtered_data(), Region %in% input$region)})
      observe({
                updateSelectInput(session,"group", 
                                  choices = unique(filtered_data_2()$Food_Sub_Category))
      })
      
      filtered_data_3 <- reactive({filter(filtered_data_2(),Food_Sub_Category %in% input$group)})

### summarized data for first plot            
      plot_data1 <- reactive({filtered_data_3() %>% 
                                      group_by(Year,Region) %>% 
                                      summarise(sum = sum(Prod_one_tho_ton))})
      
### summarized data for second plot          
      plot_data2 <- reactive({filtered_data_3() %>% 
                                      group_by(Year,Food_Sub_Category) %>% 
                                      summarise(sum = sum(Prod_one_tho_ton))})

      ### Tab 1 plot 
      output$barplot <- renderPlotly(
     {
          p<-ggplot(plot_data1(), 
                    aes_string(x=plot_data1()$Year, 
                               y=plot_data1()$sum, 
                               fill=(plot_data1()$Region))) +
            geom_bar(stat="identity") +
            labs(title = "Global Production", 
                 subtitle = "Segmented by Region", 
                 x = "Years", 
                 y = "Tons(one thousands)" )
          ggplotly(p)   
   }
   )
      

### Tab 2 plot      
      output$barplot2 <- renderPlotly(
     {
          r<-ggplot(plot_data2(), 
                    aes_string(x=plot_data2()$Year, 
                               y=plot_data2()$sum, 
                               fill=(plot_data2()$Food_Sub_Category))) +
            geom_bar(stat="identity") + 
            labs(title = "Global Production", 
                 subtitle = "Segmented by Food Category", 
                 x = "Years", y = "Tons(one thousands)" )
          ggplotly(r)   
   }
   )

### Data for
      map_plot1 <- reactive({filter(map_world_fin,Region %in% input$region)})
      
## Tab 1 map
   output$map1 <- renderPlotly(
  {
       g <-ggplot()
       g <- g + theme(legend.position="none")
       g <- g + geom_map(data=map_plot1(), map=map_plot1(), aes(map_id=region, x=long, y=lat, fill="white"))
       print(g)


}
)
               
}

# Create the Shiny app object
shinyApp(ui, server)
```
