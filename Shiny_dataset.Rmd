---
title: "Shiny App"
output: html_document
https://www.kaggle.com/dorbicycle/world-foodfeed-production/home
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# load libraries
```{r libraries}
library(tidyr)
library(devtools)
library(DataExplorer)
library(rvest)
library(dplyr)
library(lubridate)
library(stringr)
library(readr)
library(timeDate)
library(shiny)
library(plotly)
library(ggplot2)
library(Hmisc)
library(microbenchmark)
library(knitr)
library(shinythemes)
library(rgdal)
```


#Import Data
```{r import data}
# UN food production data
data <- read_csv('C:/Users/BieniekJon/Desktop/901/R/Shiny/FAO.csv')
print(data)
# UN countries by region
region <- read_csv('C:/Users/BieniekJon/Desktop/901/R/Shiny/Region list.csv')
print(region)
# Food categories
categories <- read_csv('C:/Users/BieniekJon/Desktop/901/R/Shiny/Food Categories.csv')
print(categories)
```

# Use left join to add region and food categories to the UN data set
```{r join data}
joined_data <- left_join(data,region,by = c("Area" = "Country"))
print(joined_data)

joined_data2 <- left_join(joined_data,categories,by = c("Item" = "Items"))
print(joined_data2)
```

Remove and row with an NA
```{r remove NAs}
no_na <- joined_data2[complete.cases(joined_data2),]
no_na[is.na(no_na$`Food_Sub_Category`),]
```

Subset the data
```{r}
columns_of_interest <- c("Element","Area","Region","Food_Sub_Category", "Y1961", "Y1962", "Y1963", "Y1964", "Y1965", "Y1966","Y1967","Y1968","Y1969","Y1970","Y1971","Y1972","Y1973","Y1974","Y1975","Y1976","Y1977","Y1978","Y1979","Y1980","Y1981","Y1982","Y1983","Y1984","Y1985","Y1986","Y1987","Y1988","Y1989","Y1990","Y1991","Y1992","Y1993","Y1994","Y1995","Y1996","Y1997","Y1998","Y1999","Y2000","Y2001","Y2002","Y2003","Y2004","Y2005","Y2006","Y2007","Y2008","Y2009","Y2010","Y2011","Y2012","Y2013")
data_subset <- no_na[columns_of_interest]
print(data_subset)
data_subset[is.na(data_subset),]
```

# Create a flat file using the gather() function.
```{r flat_file}
colnames(data_subset)[6] <- "Prod_one_tho_ton"
flat_file <- gather(data_subset, "Year", "Prod_one_tho_ton", 5:57)
print(flat_file)
```

Remove the letter Y from Year elements
```{r remove letter from string}

flat_file$Year <- gsub("Y", "",flat_file$Year)
print(flat_file)
```

Transform all columns except the Production column into factors. This will make ploting graphs easier.
```{r turn to factors}
flat_file$Element <- as.factor(flat_file$Element)
flat_file$Area <- as.factor(flat_file$Area)
flat_file$Region <- as.factor(flat_file$Region)
flat_file$Food_Sub_Category <- as.factor(flat_file$Food_Sub_Category)
flat_file$Year <- as.factor(flat_file$Year)
```

# Use group_by function to group the file by year and sum the # of 1,000 tons.
```{r group_by}
group_data <- flat_file %>%
  group_by(Year,Region) %>%
  summarise("Production_one_tho_tons"=n())
print(group_data)
```
```{r}
p<-ggplot(data=flat_file, aes(Year, weight=Prod_one_tho_ton)) + geom_bar()
ggplotly(p)
```


Shiny App
```{r shiny app}
library(shiny)

ui <- fluidPage(
        sidebarLayout(
                sidebarPanel(tabPanel("Global Food Production",
                                     radioButtons("rb_purpose", "Select Purpose of Food", choices = unique(flat_file$Element),selected = unique(flat_file$Element)[1]),
                                      selectInput("si_food","Select Food Category",choices = unique(flat_file$Food_Sub_Category,selected = "Choose Food Category",inline = FALSE)),
                                      sliderInput("sl_year","Years", min = 1962, max = 2013, value =c(1962,2013), sep ="" ))),
                mainPanel(
                  tabsetPanel(
                                tabPanel("Bar Graph",
                                        h2("Average Production"),
                                        plotlyOutput("bar")),
                                tabPanel("Line Graph",
                                        h2("History of Production"),
                                        plotlyOutput("bar")),
                                tabPanel("Data Table", 
                                         h2("Data Table"),
                                         dataTableOutput(outputId = "table")
                                        )
                                    )
                )
        )

)
server <- function(input, output, session) {
        filtered_data <- reactive({filter(flat_file, Element == input$rb_purpose)})
        observe({
                updateR(session,"si_food", choices = unique(filtered_data()$Food_Sub_Category))
                })
          
}

shinyApp(ui, server)
```

```{r}
# Define UI for application that plots features of movies
ui <- fluidPage(
  
  # Sidebar layout with a input and output definitions
  sidebarLayout(
    
    # Inputs
    sidebarPanel(
      tabPanel("Global Food Production",
        
        radioButtons(inputId = "purpose", 
                     label = "Intended use of Goods Produced", 
                     choices =c("Human Consumption" = "Food",
                                "Animal Consumption" = "Feed"),
                     selected = "Food"),
        
        selectInput(inputId = "region",
                    label = "Global Region:",
                    choices = unique(flat_file$Region),
                    selected = unique(flat_file$Region)[1],
                    multiple = TRUE),
        
        selectInput(inputId = "group",
                    label = "Food Category:",
                    choices = unique(flat_file$Food_Sub_Category),
                    selected = unique(flat_file$Food_Sub_Category)[1],
                    multiple = TRUE)
                    )
                  ),
      
      # Outputs
      mainPanel(
        tabsetPanel(
          tabPanel("Bar Plot",
                   h2("Total Production"),
                   plotlyOutput(outputId = "barplot")),
          tabPanel("Data Table",
                  h2("Data Table"),
                  dataTableOutput(outputId = "table")
                    )
                  )
                )
              )
            )
# Define server function required to create the scatterplot
server <- function(input, output,session) {
      filtered_data <- reactive({filter(flat_file, Element == input$purpose)})
      observe({
                updateSelectInput(session,"region", choices = unique(filtered_data()$Region))
      })
      
      filtered_data_2 <- reactive({filter(filtered_data(), Region %in% input$region)})
      observe({
                updateSelectInput(session,"group", choices = unique(filtered_data_2()$Food_Sub_Category))
      })
      filtered_data_3 <- reactive({filter(filtered_data_2(),Food_Sub_Category %in% input$group)})

# Create scatterplot
      output$barplot <- renderPlotly(
     {
          p<-ggplot(filtered_data_3(), aes(Year, weight=Prod_one_tho_ton)) + geom_bar()
          ggplotly(p)   
   }
   )
 }

# Create the Shiny app object
shinyApp(ui, server)
```
     filtered_data_2 <- reactive({filter(filtered_data(), Region %in% input$region)})
